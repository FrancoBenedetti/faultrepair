<template>
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <!-- Unified Dashboard Header -->
      <UnifiedDashboardHeader
        :org-name="getOrganizationName()"
        :profile-completeness="profileCompleteness"
        :user-role="userRole"
        :role-display-names="roleDisplayNames"
        dashboard-type="service-provider"
        :show-invite-users="userRole === 3"
        @navigate="handleNavigate"
      />

      <!-- Collapsible User Identity -->
      <CollapsibleUserIdentity
        :user-name="getCurrentUserName()"
        :organization-name="getOrganizationName()"
        :user-role="userRole"
        :is-collapsed-default="false"
      />

      <!-- Administrator Settings Section - Role 3 Only -->
      <div class="admin-settings-container bg-white rounded-xl shadow-lg border border-gray-200 p-0 mb-8" v-if="userRole === 3">
        <div class="admin-section-header rounded-t-xl bg-white rounded-b-none p-6 pb-4">
          <div class="section-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-0 pb-0 border-b border-neutral-200" @click="toggleSection('administrator-settings')" style="cursor: pointer;">
            <div class="section-title flex items-center gap-3">
              <button class="expand-btn" :class="{ expanded: sectionsExpanded['administrator-settings'] }">
                <span class="material-icon-sm">admin_panel_settings</span>
              </button>
              <h2 class="text-title-large text-on-surface mb-0 flex items-center gap-3">
                <span class="material-icon text-purple-600">admin_panel_settings</span>
                Administrator Settings
              </h2>
            </div>
          </div>
        </div>

        <div v-show="sectionsExpanded['administrator-settings']" class="admin-subsections bg-gray-50 rounded-b-xl border-t border-gray-200">
          <div class="p-6 space-y-6">

            <!-- Business Profile Sub-Section -->
            <div class="subsection-card" v-if="userRole === 3">
              <div class="subsection-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 pb-2 border-b border-gray-300" @click="toggleSection('profile')" style="cursor: pointer;">
                <div class="subsection-title flex items-center gap-3">
                  <button class="expand-btn small" :class="{ expanded: sectionsExpanded.profile }">
                    <span class="material-icon-sm">expand_more</span>
                  </button>
                  <h4 class="text-title-medium text-on-surface mb-0 flex items-center gap-3">
                    <span class="material-icon text-blue-600">business</span>
                    Business Profile
                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">{{ technicianProfileCompleteness }}% Complete</span>
                  </h4>
                </div>
                <button @click.stop="showProfileModal = true" class="btn-outlined btn-small flex items-center gap-2">
                  <span class="material-icon-sm">edit</span>
                  Edit Profile
                </button>
              </div>

              <div v-show="sectionsExpanded.profile" class="subsection-content transition-all duration-300 ease-in-out">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Basic Info -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-4">
                    <span class="material-icon text-blue-600">business_center</span>
                    <h4 class="font-semibold text-gray-900">Basic Information</h4>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm font-medium text-gray-600">Business Name</label>
                      <p class="text-gray-900">{{ profile.name || 'Not set' }}</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-600">Website</label>
                      <p class="text-gray-900">{{ profile.website || 'Not set' }}</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-600">Status</label>
                      <span :class="[
                        'px-2 py-1 rounded-full text-xs font-medium',
                        profile.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                      ]">
                        {{ profile.is_active ? 'Active' : 'Inactive' }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Contact Info -->
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-4">
                    <span class="material-icon text-green-600">contact_phone</span>
                    <h4 class="font-semibold text-gray-900">Contact Information</h4>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm font-medium text-gray-600">Manager</label>
                      <p class="text-gray-900">{{ profile.manager_name || 'Not set' }}</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-600">Email</label>
                      <p class="text-gray-900">{{ profile.manager_email || 'Not set' }}</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-600">Phone</label>
                      <p class="text-gray-900">{{ profile.manager_phone || 'Not set' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Address and Description -->
              <div class="mt-6 bg-white border border-gray-200 rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <div class="flex items-center gap-2 mb-3">
                      <span class="material-icon text-gray-600">location_on</span>
                      <label class="font-semibold text-gray-900">Business Address</label>
                    </div>
                    <p class="text-gray-700 whitespace-pre-wrap">{{ profile.address || 'No address set' }}</p>
                  </div>
                  <div>
                    <div class="flex items-center gap-2 mb-3">
                      <span class="material-icon text-gray-600">description</span>
                      <label class="font-semibold text-gray-900">Business Description</label>
                    </div>
                    <p class="text-gray-700 line-clamp-3">{{ profile.description || 'No description set' }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

            <!-- Services Offered Sub-Section -->
            <div class="subsection-card" v-if="userRole === 3">
            <div class="section-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 pb-2 border-b border-gray-200" @click="toggleSection('services')" style="cursor: pointer;">
              <div class="section-title flex items-center gap-3">
                <button class="expand-btn small" :class="{ expanded: sectionsExpanded.services }">
                  <span class="material-icon-sm">expand_more</span>
                </button>
                <h3 class="text-title-medium text-on-surface mb-0 flex items-center gap-3">
                  <span class="material-icon text-green-600">build</span>
                  Services Offered
                </h3>
              </div>
              <button @click.stop="showServicesModal = true" class="btn-outlined btn-small flex items-center gap-2">
                <span class="material-icon-sm">settings</span>
                Configure
              </button>
            </div>

            <div v-show="sectionsExpanded.services" class="section-content transition-all duration-300 ease-in-out">
              <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h4 class="font-semibold text-gray-900">Configured Services ({{ services.length }})</h4>
                    <span class="text-sm text-gray-600">Click "Configure" to manage services</span>
                  </div>
                </div>

                <div v-if="services.length === 0" class="p-8 text-center">
                  <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-100 mb-4">
                    <span class="material-icon text-gray-400">build</span>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">No Services Configured</h3>
                  <p class="text-gray-600 mb-4">Configure your services to start accepting jobs.</p>
                  <button @click="showServicesModal = true" class="btn-filled">
                    Configure Services
                  </button>
                </div>

                <div v-else class="divide-y divide-gray-200">
                  <div v-for="service in services" :key="service.id" class="p-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" :style="{ backgroundColor: getCategoryColor(service.category) }">
                          <span class="material-icon-sm text-white">{{ getCategoryIcon(service.category) }}</span>
                        </div>
                        <div>
                          <div class="font-medium text-gray-900">{{ service.name }}</div>
                          <div class="text-sm text-gray-600">{{ service.category }}</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <span v-if="service.is_primary" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                          Primary
                        </span>
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                          Active
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

            <!-- Service Regions Sub-Section -->
            <div class="subsection-card" v-if="userRole === 3">
              <div class="subsection-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 pb-2 border-b border-gray-300" @click="toggleSection('regions')" style="cursor: pointer;">
                <div class="subsection-title flex items-center gap-3">
                  <button class="expand-btn small" :class="{ expanded: sectionsExpanded.regions }">
                    <span class="material-icon-sm">expand_more</span>
                  </button>
                  <h4 class="text-title-medium text-on-surface mb-0 flex items-center gap-3">
                    <span class="material-icon text-orange-600">location_on</span>
                    Service Regions
                  </h4>
                </div>
                <button @click.stop="showRegionsModal = true" class="btn-outlined btn-small flex items-center gap-2">
                  <span class="material-icon-sm">settings</span>
                  Configure
                </button>
              </div>

              <div v-show="sectionsExpanded.regions" class="subsection-content transition-all duration-300 ease-in-out">
              <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="p-4 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h4 class="font-semibold text-gray-900">Active Regions ({{ regions.length }})</h4>
                    <span class="text-sm text-gray-600">Click "Configure" to manage regions</span>
                  </div>
                </div>

                <div v-if="regions.length === 0" class="p-8 text-center">
                  <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-100 mb-4">
                    <span class="material-icon text-gray-400">location_off</span>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-900 mb-2">No Regions Configured</h3>
                  <p class="text-gray-600 mb-4">Configure your service regions to define where you operate.</p>
                  <button @click="showRegionsModal = true" class="btn-filled">
                    Configure Regions
                  </button>
                </div>

                <div v-else class="divide-y divide-gray-200">
                  <div v-for="region in regions" :key="region.id" class="p-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center bg-orange-500">
                          <span class="material-icon-sm text-white">location_on</span>
                        </div>
                        <div>
                          <div class="font-medium text-gray-900">{{ region.name }}</div>
                          <div class="text-sm text-gray-600">{{ region.code }}</div>
                        </div>
                      </div>
                      <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                        Active
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

            <!-- Users Sub-Section -->
            <div class="subsection-card" v-if="userRole === 3">
              <div class="subsection-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-4 pb-2 border-b border-gray-300" @click="toggleSection('technicians')" style="cursor: pointer;">
                <div class="subsection-title flex items-center gap-3">
                  <button class="expand-btn small" :class="{ expanded: sectionsExpanded.technicians }">
                    <span class="material-icon-sm">expand_more</span>
                  </button>
                  <h4 class="text-title-medium text-on-surface mb-0 flex items-center gap-3">
                    <span class="material-icon text-blue-600">group</span>
                    Users
                  </h4>
                </div>
                <button @click.stop="openAddTechnicianModal" class="btn-outlined btn-small flex items-center gap-2">
                  <span class="material-icon-sm">person_add</span>
                  Add User
                </button>
              </div>

              <div v-show="sectionsExpanded.technicians" class="subsection-content transition-all duration-300 ease-in-out">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="technician in technicians" :key="technician.id" class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow">
                  <div class="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 rounded-full flex items-center justify-center" :class="technician.role_id === 3 ? 'bg-blue-600' : 'bg-purple-600'">
                        <span class="material-icon text-white">{{
                          technician && technician.full_name ?
                            technician.full_name.charAt(0).toUpperCase() :
                            technician && technician.username ?
                            technician.username.charAt(0).toUpperCase() :
                            'T'
                        }}</span>
                      </div>
                      <div>
                        <h3 class="font-semibold text-gray-900">{{ technician.full_name || 'Unnamed User' }}</h3>
                        <div class="flex gap-2">
                          <span :class="[
                            'px-2 py-1 rounded-full text-xs font-medium',
                            technician.role_id === 3 ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'
                          ]">
                            {{ roleDisplayNames && roleDisplayNames[technician.role_id] ? roleDisplayNames[technician.role_id] : getFallbackRoleName(technician.role_id) }}
                          </span>
                          <span :class="[
                            'px-2 py-1 rounded-full text-xs font-medium',
                            technician.is_active
                              ? 'bg-green-100 text-green-800'
                              : 'bg-red-100 text-red-800'
                          ]">
                            {{ technician.is_active ? 'Active' : 'Inactive' }}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button @click="viewTechnicianJobs(technician)" class="btn-round" title="View Jobs">
                        <span class="material-icon-sm">work</span>
                      </button>
                      <button @click="editTechnician(technician)" class="btn-round" title="Edit Technician">
                        <span class="material-icon-sm">edit</span>
                      </button>
                      <button @click="deleteTechnician(technician)" class="btn-round-filled" title="Delete Technician">
                        <span class="material-icon-sm">delete</span>
                      </button>
                    </div>
                  </div>

                  <div class="p-4">
                    <p class="text-sm text-gray-600 flex items-center gap-1 mb-2">
                      <span class="material-icon-sm">email</span>
                      {{ technician.email }}
                    </p>
                    <p v-if="technician.phone" class="text-sm text-gray-600 flex items-center gap-1">
                      <span class="material-icon-sm">phone</span>
                      {{ technician.phone }}
                    </p>
                  </div>

                  <div class="px-4 pb-4">
                    <p class="text-xs text-gray-500">
                      Added {{ formatDate(technician.created_at) }}
                    </p>
                  </div>
                </div>

                <!-- Add Technician Card -->
                <button @click="openAddTechnicianModal" class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-purple-400 hover:bg-purple-50 transition-colors flex flex-col items-center justify-center gap-3 text-gray-500 hover:text-purple-600">
                  <span class="material-icon text-3xl">person_add</span>
                  <div class="text-center">
                    <div class="font-medium">Add Technician</div>
                    <div class="text-sm">Create a new technician account</div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Jobs Management Section -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
        <div class="section-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 pb-4 border-b border-neutral-200" @click="sectionsExpanded.jobs = !sectionsExpanded.jobs" style="cursor: pointer;">
          <div class="section-title flex items-center gap-3">
            <button class="expand-btn" :class="{ expanded: sectionsExpanded.jobs }">
              <span class="material-icon-sm">expand_more</span>
            </button>
            <h2 class="text-title-large text-on-surface mb-0 flex items-center gap-3">
              <span class="material-icon text-blue-600">work</span>
              Job Management
              <span v-if="jobs?.length" class="text-sm font-normal text-blue-600">({{ jobs.length }})</span>
            </h2>
          </div>
          <button @click.stop="loadJobs()" class="btn-outlined flex items-center gap-2">
            <span class="material-icon-sm">refresh</span>
            Refresh
          </button>
        </div>

        <div v-show="sectionsExpanded.jobs" class="section-content transition-all duration-300 ease-in-out">
          <JobManagementSectionSP
            :jobs="jobs"
            :job-filters="jobFilters"
            :approved-clients="approvedClients"
            :technicians="technicians"
            :user-role="userRole"
            @update-job-filters="jobFilters = $event; loadJobs()"
            @refresh-jobs="loadJobs"
            @view-job-details="selectedJob = $event; showJobDetailsModal = true"
            @edit-job="handleEditJob"
            @toggle-archive-job="toggleArchiveJob"
          />
        </div>
      </div>

      <!-- Quote Management Section -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
        <div class="section-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 pb-4 border-b border-neutral-200" @click="sectionsExpanded.quotes = !sectionsExpanded.quotes" style="cursor: pointer;">
          <div class="section-title flex items-center gap-3">
            <button class="expand-btn" :class="{ expanded: sectionsExpanded.quotes }">
              <span class="material-icon-sm">expand_more</span>
            </button>
            <h2 class="text-title-large text-on-surface mb-0 flex items-center gap-3">
              <span class="material-icon text-green-600">request_quote</span>
              Quote Management
            </h2>
          </div>
          <button @click.stop="loadQuotes" class="btn-outlined btn-small flex items-center gap-2">
            <span class="material-icon-sm">refresh</span>
            Refresh Quotes
          </button>
        </div>

        <div v-show="sectionsExpanded.quotes" class="section-content transition-all duration-300 ease-in-out">
          <!-- Quote Filters -->
          <div class="quote-filters flex flex-wrap gap-4 mb-6 p-4 bg-green-50 rounded-lg">
            <div class="filter-group min-w-40">
              <label for="quote-status-filter" class="form-label mb-1">Quote Status:</label>
              <select id="quote-status-filter" v-model="quoteFilters.status" @change="loadQuotes" class="form-input">
                <option value="">All Quotes</option>
                <option value="draft">Draft</option>
                <option value="submitted">Submitted</option>
                <option value="accepted">Accepted</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="filter-group min-w-40">
              <label for="quote-job-filter" class="form-label mb-1">Job:</label>
              <select id="quote-job-filter" v-model="quoteFilters.job_id" @change="loadQuotes" class="form-input">
                <option value="">All Jobs</option>
                <option v-for="job in quoteJobs" :key="job.id" :value="job.id">
                  {{ job.item_identifier || 'Job #' + job.id }}
                </option>
              </select>
            </div>
          </div>

          <!-- Loading state -->
          <div v-if="quotes === null" class="loading-state text-center py-16">
            <div class="loading-spinner w-10 h-10 border-4 border-neutral-200 border-t-green-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-body-large text-on-surface-variant">Loading quotes...</p>
          </div>

          <!-- Quotes Grid -->
          <div v-else-if="quotes && quotes.length > 0" class="quotes-grid grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div v-for="quote in quotes" :key="quote.id" class="quote-card card overflow-hidden">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div class="quote-status uppercase">
                  <span class="status-badge" :class="getQuoteStatusClass(quote.status)">
                    {{ quote.status }}
                  </span>
                </div>

                <div class="quote-actions flex gap-2">
                  <button @click="viewQuoteDetails(quote)" class="btn-outlined btn-small">
                    <span class="material-icon-sm">visibility</span>
                    View
                  </button>
                  <button v-if="quote.status === 'draft'" @click="editQuote(quote)" class="btn-outlined btn-small">
                    <span class="material-icon-sm">edit</span>
                    Edit
                  </button>
                  <button v-if="quote.status === 'draft'" @click="submitQuote(quote)" class="btn-filled btn-small">
                    <span class="material-icon-sm">send</span>
                    Submit
                  </button>
                </div>
              </div>

              <div class="quote-content card-content">
                <h3 class="quote-title text-title-medium text-on-surface mb-2">
                  {{ quote.item_identifier || 'Job #' + quote.job_id }}
                </h3>
                <p class="quote-description text-body-medium text-on-surface-variant mb-2 line-clamp-2">
                  {{ quote.fault_description }}
                </p>

                <div class="quote-amount text-lg font-bold text-green-600 mb-2">
                  {{ formatCurrency(quote.quotation_amount) }}
                </div>

                <div class="quote-meta space-y-1 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Client:</span>
                    <span class="font-medium">{{ quote.client_name }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Location:</span>
                    <span class="font-medium">{{ quote.location_name }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Valid Until:</span>
                    <span class="font-medium">{{ formatDate(quote.valid_until) }}</span>
                  </div>
                  <div v-if="quote.submitted_at" class="flex justify-between">
                    <span class="text-gray-600">Submitted:</span>
                    <span class="font-medium">{{ formatDate(quote.submitted_at) }}</span>
                  </div>
                </div>
              </div>

              <div class="quote-footer card-footer">
                <div class="quote-description-preview text-sm text-gray-600 italic">
                  "{{ quote.quotation_description?.substring(0, 100) }}{{ quote.quotation_description?.length > 100 ? '...' : '' }}"
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-else class="text-center py-16">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-100 mb-6">
              <span class="material-icon text-gray-400">request_quote</span>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No Quotes Yet</h3>
            <p class="text-gray-600">Quotes you create for jobs will appear here.</p>
          </div>
        </div>
      </div>

      <!-- Approved Clients Section -->
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 mb-8">
        <div class="section-header flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6 pb-4 border-b border-neutral-200" @click="toggleSection('clients')" style="cursor: pointer;">
          <div class="section-title flex items-center gap-3">
            <button class="expand-btn" :class="{ expanded: sectionsExpanded.clients }">
              <span class="material-icon-sm">expand_more</span>
            </button>
            <h2 class="text-title-large text-on-surface mb-0 flex items-center gap-3">
              <span class="material-icon text-blue-600">group</span>
              Approved Clients
            </h2>
          </div>
        </div>

        <div v-show="sectionsExpanded.clients" class="section-content transition-all duration-300 ease-in-out">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div v-for="client in approvedClients" :key="client.id" class="bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center">
                    <span class="material-icon text-white">{{ client.name.charAt(0) }}</span>
                  </div>
                  <div>
                    <h3 class="font-semibold text-gray-900">{{ client.name }}</h3>
                    <p class="text-sm text-gray-600 flex items-center gap-1">
                      <span class="material-icon-sm">location_on</span>
                      {{ client.address }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Job Statistics -->
              <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="text-center">
                  <div class="text-lg font-bold text-blue-600">{{ client.total_jobs }}</div>
                  <div class="text-xs text-gray-600">Total Jobs</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold text-green-600">{{ client.active_jobs }}</div>
                  <div class="text-xs text-gray-600">Active</div>
                </div>
                <div class="text-center">
                  <div class="text-lg font-bold text-gray-600">{{ client.completed_jobs }}</div>
                  <div class="text-xs text-gray-600">Completed</div>
                </div>
              </div>

              <div class="flex gap-2">
                <button @click="viewClientJobs(client.id)" class="btn-filled btn-small flex items-center gap-1 flex-1">
                  <span class="material-icon-sm">work</span>
                  View Jobs
                </button>
              </div>

              <div class="mt-3 pt-3 border-t border-gray-200">
                <p class="text-xs text-gray-500 flex items-center gap-1">
                  <span class="material-icon-sm">event_available</span>
                  Approved {{ formatDate(client.approved_at) }}
                </p>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="approvedClients.length === 0" class="text-center py-16">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gray-100 mb-6">
              <span class="material-icon text-gray-400">group</span>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No Approved Clients Yet</h3>
            <p class="text-gray-600">Clients will appear here once they approve your services.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Business Profile Modal -->
    <div v-if="showProfileModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="showProfileModal = false"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-blue-600">business</span>
            Edit Business Profile
          </h3>
          <button @click="showProfileModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <!-- Form -->
        <form @submit.prevent="updateProfile" class="p-6 space-y-8 overflow-y-auto max-h-[calc(90vh-140px)]">
          <!-- Basic Information -->
          <div class="bg-gray-50 rounded-lg p-6 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2">
              <span class="material-icon-sm text-blue-600">business_center</span>
              Basic Information
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="business-name" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">store</span>
                  Business Name *
                </label>
                <input
                  type="text"
                  id="business-name"
                  v-model="editForm.name"
                  required
                  class="form-input"
                  placeholder="Your business name"
                >
              </div>
              <div class="space-y-2">
                <label for="business-website" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">link</span>
                  Website
                </label>
                <input
                  type="url"
                  id="business-website"
                  v-model="editForm.website"
                  class="form-input"
                  placeholder="https://yourbusiness.com"
                >
              </div>
            </div>

            <div class="space-y-2">
              <label for="business-address" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">location_on</span>
                Business Address
              </label>
              <textarea
                id="business-address"
                v-model="editForm.address"
                rows="3"
                class="form-input"
                placeholder="Business address"
              ></textarea>
            </div>

            <div class="space-y-2">
              <label for="business-description" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">description</span>
                Business Description
              </label>
              <textarea
                id="business-description"
                v-model="editForm.description"
                rows="4"
                class="form-input"
                placeholder="Brief description of your business and services"
              ></textarea>
            </div>
          </div>

          <!-- Manager Contact -->
          <div class="bg-gray-50 rounded-lg p-6 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2">
              <span class="material-icon-sm text-green-600">contact_phone</span>
              Manager Contact Information
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="manager-name" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">person</span>
                  Manager Name
                </label>
                <input
                  type="text"
                  id="manager-name"
                  v-model="editForm.manager_name"
                  class="form-input"
                  placeholder="Primary contact person"
                >
              </div>
              <div class="space-y-2">
                <label for="manager-email" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">email</span>
                  Manager Email
                </label>
                <input
                  type="email"
                  id="manager-email"
                  v-model="editForm.manager_email"
                  class="form-input"
                  placeholder="manager@yourbusiness.com"
                >
              </div>
            </div>

            <div class="space-y-2">
              <label for="manager-phone" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">phone</span>
                Manager Phone
              </label>
              <input
                type="tel"
                id="manager-phone"
                v-model="editForm.manager_phone"
                class="form-input"
                placeholder="+27 12 345 6789"
              >
            </div>
          </div>

          <!-- Business Details -->
          <div class="bg-gray-50 rounded-lg p-6 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2">
              <span class="material-icon-sm text-purple-600">assignment</span>
              Business Registration Details
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="vat-number" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">receipt</span>
                  VAT Number
                </label>
                <input
                  type="text"
                  id="vat-number"
                  v-model="editForm.vat_number"
                  class="form-input"
                  placeholder="VAT registration number"
                >
              </div>
              <div class="space-y-2">
                <label for="business-registration" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">business</span>
                  Business Registration Number
                </label>
                <input
                  type="text"
                  id="business-registration"
                  v-model="editForm.business_registration_number"
                  class="form-input"
                  placeholder="Company registration number"
                >
              </div>
            </div>

            <div class="space-y-2">
              <label for="business-status" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">toggle_on</span>
                Status
              </label>
              <input
                type="text"
                id="business-status"
                :value="editForm.is_active ? 'Active' : 'Inactive'"
                class="form-input"
                readonly
              >
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
            <button
              type="button"
              @click="showProfileModal = false"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">close</span>
              {{ loading ? 'Canceling...' : 'Cancel' }}
            </button>
            <button
              type="submit"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">save</span>
              {{ loading ? 'Updating...' : 'Update Profile' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Services Modal -->
    <div v-if="showServicesModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="showServicesModal = false"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-blue-600">settings</span>
            Configure Services
          </h3>
          <button @click="showServicesModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)] space-y-6">
          <!-- Search and Filter -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <input
                type="text"
                v-model="searchTerm"
                placeholder="Search services..."
                class="form-input"
                @input="debouncedSearch"
              >
            </div>
            <div class="flex gap-2">
              <button @click="expandAllCategories" class="btn-outlined btn-small">
                <span class="material-icon-sm">expand_more</span>
                Expand All
              </button>
              <button @click="collapseAllCategories" class="btn-outlined btn-small">
                <span class="material-icon-sm">expand_less</span>
                Collapse All
              </button>
            </div>
          </div>

          <!-- Services by Categories -->
          <div v-for="category in getFilteredCategories()" :key="category" class="bg-gray-50 rounded-lg mb-4 overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-200 cursor-pointer" @click="toggleCategoryExpansion(category)">
              <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-3">
                <button class="small-category-btn" :class="{ expanded: expandedCategories[category] }">
                  <span class="material-icon-sm">expand_more</span>
                </button>
                <span>{{ category }}</span>
                <span class="text-sm text-gray-600 bg-gray-200 px-2 py-1 rounded-full">
                  {{ getServicesByCategory(category).length }}
                </span>
              </h4>
              <div class="flex items-center gap-3">
                <span v-if="isCategoryFullySelected(category)" class="text-sm text-green-600 flex items-center gap-1">
                  <span class="material-icon-sm">check_circle</span>
                  All Selected
                </span>
                <span v-else-if="isCategoryPartiallySelected(category)" class="text-sm text-orange-600 flex items-center gap-1">
                  <span class="material-icon-sm">radio_button_partial</span>
                  Some Selected
                </span>
                <span v-else class="text-sm text-gray-600 flex items-center gap-1">
                  <span class="material-icon-sm">radio_button_unchecked</span>
                  None Selected
                </span>
                <div class="flex gap-2">
                  <button @click.stop="selectAllInCategory(category)" class="btn-outlined btn-very-small">Select All</button>
                  <button @click.stop="deselectAllInCategory(category)" class="btn-outlined btn-very-small">Deselect All</button>
                </div>
              </div>
            </div>

            <div v-show="expandedCategories[category]" class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div
                  v-for="service in getServicesByCategory(category)"
                  :key="service.id"
                  class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                  @click="selectedServices.includes(service.id) ? selectedServices.splice(selectedServices.indexOf(service.id), 1) : selectedServices.push(service.id)"
                >
                  <input
                    type="checkbox"
                    :checked="selectedServices.includes(service.id)"
                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                    @click.stop
                    @change="selectedServices.includes(service.id) ? selectedServices.splice(selectedServices.indexOf(service.id), 1) : selectedServices.push(service.id)"
                  >
                  <div class="w-10 h-10 rounded-lg flex items-center justify-center" :style="{ backgroundColor: getCategoryColor(service.category) }">
                    <span class="material-icon-sm text-white">{{ getCategoryIcon(service.category) }}</span>
                  </div>
                  <div class="flex-1">
                    <div class="font-medium text-gray-900">{{ service.name }}</div>
                    <div class="text-sm text-gray-600">{{ service.category }}</div>
                  </div>
                  <div v-if="primaryServiceId === service.id" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">
                    Primary
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Primary Service Selection -->
          <div class="bg-blue-50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
              <span class="material-icon-sm text-blue-600">star</span>
              Set Primary Service
            </h4>
            <p class="text-sm text-gray-700 mb-4">
              Your primary service will be highlighted to clients. You can change this later.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <button
                v-for="serviceId in selectedServices"
                :key="serviceId"
                @click="setPrimaryService(serviceId)"
                :class="[
                  'p-3 rounded-lg border text-left transition-all',
                  primaryServiceId === serviceId
                    ? 'bg-blue-600 text-white border-blue-600'
                    : 'bg-white border-gray-300 hover:bg-gray-50'
                ]"
              >
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-lg flex items-center justify-center" :style="{ backgroundColor: primaryServiceId === serviceId ? '#ffffff33' : getCategoryColor(getServiceName(serviceId).split(' - ')[1] || 'Other') }">
                    <span class="material-icon-sm" :class="primaryServiceId === serviceId ? 'text-white' : 'text-white'">
                      {{ getCategoryIcon(getServiceName(serviceId).split(' - ')[1] || 'Other') }}
                    </span>
                  </div>
                  <div>
                    <div class="font-medium" :class="primaryServiceId === serviceId ? 'text-white' : 'text-gray-900'">
                      {{ getServiceName(serviceId) }}
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
            <button
              type="button"
              @click="showServicesModal = false"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">close</span>
              {{ loading ? 'Saving...' : 'Cancel' }}
            </button>
            <button
              type="button"
              @click="updateServices"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">save</span>
              {{ loading ? 'Saving...' : 'Save Services' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Technician Modal -->
    <div v-if="showAddTechnicianModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="closeAddTechnicianModal"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-purple-600">person_add</span>
            Add New Technician
          </h3>
          <button @click="closeAddTechnicianModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

    <!-- Form -->
    <form @submit.prevent="createTechnician" class="p-6 space-y-6">
      <!-- First Name and Last Name Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="tech_first_name" class="form-label flex items-center gap-2">
            <span class="material-icon-sm text-gray-500">badge</span>
            First Name *
          </label>
          <input
            type="text"
            id="tech_first_name"
            v-model="technicianForm.first_name"
            required
            class="form-input"
            placeholder="Enter first name"
          >
        </div>
        <div>
          <label for="tech_last_name" class="form-label flex items-center gap-2">
            <span class="material-icon-sm text-gray-500">badge</span>
            Last Name *
          </label>
          <input
            type="text"
            id="tech_last_name"
            v-model="technicianForm.last_name"
            required
            class="form-input"
            placeholder="Enter last name"
          >
        </div>
      </div>

      <!-- Email Row -->
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="tech_email" class="form-label flex items-center gap-2">
            <span class="material-icon-sm text-gray-500">email</span>
            Email Address *
          </label>
          <input
            type="email"
            id="tech_email"
            v-model="technicianForm.email"
            required
            class="form-input"
            placeholder="Enter email address"
          >
        </div>
      </div>

          <!-- Phone Row -->
          <div class="grid grid-cols-1 gap-4">
            <div>
              <label for="tech_phone" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">phone</span>
                Phone Number
              </label>
              <input
                type="tel"
                id="tech_phone"
                v-model="technicianForm.phone"
                class="form-input"
                placeholder="Enter phone number"
              >
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button
              type="button"
              @click="closeAddTechnicianModal"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">close</span>
              {{ loading ? 'Creating...' : 'Cancel' }}
            </button>
            <button
              type="submit"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">person_add</span>
              {{ loading ? 'Creating...' : 'Create Technician' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Technician Modal -->
    <div v-if="showEditTechnicianModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="closeEditTechnicianModal"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-purple-600">edit</span>
            Edit Technician
          </h3>
          <button @click="closeEditTechnicianModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <!-- Form -->
        <form @submit.prevent="updateTechnician" class="p-6 space-y-6">
          <!-- First Name and Last Name Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="edit_first_name" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">badge</span>
                First Name
              </label>
              <input
                type="text"
                id="edit_first_name"
                v-model="technicianForm.first_name"
                class="form-input"
                placeholder="Enter first name"
              >
            </div>
            <div>
              <label for="edit_last_name" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">badge</span>
                Last Name
              </label>
              <input
                type="text"
                id="edit_last_name"
                v-model="technicianForm.last_name"
                class="form-input"
                placeholder="Enter last name"
              >
            </div>
          </div>

          <!-- Email AND Phone Row -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="edit_email" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">email</span>
                Email Address
              </label>
              <input
                type="email"
                id="edit_email"
                v-model="technicianForm.email"
                class="form-input"
                placeholder="Enter email address"
              >
            </div>
            <div>
              <label for="edit_phone" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">phone</span>
                Phone Number
              </label>
              <input
                type="tel"
                id="edit_phone"
                v-model="technicianForm.phone"
                class="form-input"
                placeholder="Enter phone number"
              >
            </div>
          </div>

          <!-- Role and Status Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div v-if="userRole === 3">
              <label for="edit_role" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">admin_panel_settings</span>
                Role
              </label>
              <select
                id="edit_role"
                v-model="technicianForm.role_id"
                class="form-input"
                :disabled="editingTechnician && editingTechnician.id === currentUserId"
              >
                <option
                  v-for="(name, id) in roleDisplayNames"
                  :key="id"
                  :value="parseInt(id)"
                  :disabled="editingTechnician && editingTechnician.id === currentUserId"
                >
                  {{ name }}
                </option>
              </select>
              <small v-if="editingTechnician && editingTechnician.id === currentUserId" class="form-help text-sm text-gray-500 mt-1">
                You cannot change your own role
              </small>
            </div>
            <div v-if="userRole === 3">
              <label for="edit_status" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">toggle_on</span>
                Status
              </label>
              <select
                id="edit_status"
                v-model="technicianForm.is_active"
                class="form-input"
              >
                <option :value="true">Active</option>
                <option :value="false">Inactive</option>
              </select>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button
              type="button"
              @click="closeEditTechnicianModal"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">close</span>
              {{ loading ? 'Updating...' : 'Cancel' }}
            </button>
            <button
              type="submit"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">save</span>
              {{ loading ? 'Updating...' : 'Update Technician' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Job Details Modal -->
    <div v-if="showJobDetailsModal" class="modal-overlay" @click="showJobDetailsModal = false">
      <div class="modal-content large-modal" @click.stop>
        <div class="modal-header">
          <h3 class="flex items-center gap-3">
            <span class="material-icon text-blue-600">work</span>
            Job Details: {{ selectedJob?.item_identifier || 'No Item ID' }}
          </h3>
          <button @click="showJobDetailsModal = false" class="close-btn">&times;</button>
        </div>

        <div v-if="selectedJob" class="p-6 overflow-y-auto max-h-[calc(90vh-140px)] space-y-6">
          <!-- Job Information -->
          <div class="job-info-section">
            <div class="info-grid">
              <div class="info-item">
                <label>Status:</label>
                <span class="status-badge" :class="getStatusClass(selectedJob.job_status)">
                  {{ selectedJob.job_status }}
                </span>
              </div>
              <div class="info-item">
                <label>Location:</label>
                <a :href="`https://maps.google.com/maps?q=${encodeURIComponent(selectedJob.location_coordinates || selectedJob.location_name)}`"
                   target="_blank"
                   class="location-link text-blue-600 hover:text-blue-800 underline">
                  {{ selectedJob.location_name }}
                </a>
              </div>
              <div class="info-item">
                <label>Reported By:</label>
                <span>{{ selectedJob.reporting_user }}</span>
              </div>
              <div class="info-item">
                <label>Date Reported:</label>
                <span>{{ formatDate(selectedJob.created_at) }}</span>
              </div>
              <div v-if="selectedJob.assigned_provider_name" class="info-item">
                <label>Assigned Provider:</label>
                <span>{{ selectedJob.assigned_provider_name }}</span>
              </div>
              <div class="info-item">
                <label>Last Updated:</label>
                <span>{{ formatDate(selectedJob.updated_at) }}</span>
              </div>
            </div>

            <div class="description-section">
              <label>Service Description:</label>
              <p class="fault-description">{{ selectedJob.fault_description }}</p>
            </div>

            <div v-if="selectedJob.contact_person" class="contact-section">
              <label>Contact Person:</label>
              <span>{{ selectedJob.contact_person }}</span>
            </div>

            <!-- Site Information -->
            <div v-if="selectedJob.location_access_rules || selectedJob.location_access_instructions" class="access-section">
              <!-- Site Information Link -->
              <div v-if="selectedJob.location_access_rules" class="info-item">
                <label>Site Information:</label>
                <a :href="selectedJob.location_access_rules"
                   target="_blank"
                   class="access-link text-green-600 hover:text-green-800 underline">
                   Open Site Information
                </a>
              </div>

              <!-- Access Instructions -->
              <div v-if="selectedJob.location_access_instructions" class="info-item">
                <label>Access Instructions:</label>
                <div class="access-instructions-content">{{ selectedJob.location_access_instructions }}</div>
              </div>
            </div>
          </div>

          <!-- Technician Notes (visible to service providers only) -->
          <div v-if="(userRole === 3 || userRole === 4) && selectedJob.technician_notes" class="technician-notes-section">
            <h4>Technician Notes</h4>
            <div class="technician-notes-content">
              <p>{{ selectedJob.technician_notes }}</p>
            </div>
          </div>

          <!-- Images Gallery -->
          <div class="images-section">
            <h4>Attached Images ({{ selectedJob.images?.length || 0 }})</h4>

            <div v-if="!selectedJob.images || selectedJob.images.length === 0" class="no-images">
              <div class="no-images-icon"></div>
              <p>No images attached to this job</p>
            </div>

              <div v-else class="images-gallery">
                <div class="gallery-grid">
                  <div v-for="image in selectedJob.images" :key="image.id" class="gallery-item">
                    <img :src="generateImageUrl(image)"
                         :alt="image.original_filename"
                         class="gallery-image"
                         @click="openImageModal(image)">
                    <div class="image-overlay">
                      <span class="image-filename">{{ image.original_filename }}</span>
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Edit Quote Modal -->
    <div v-if="showEditQuoteModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="closeEditQuoteModal"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-green-600">edit</span>
            Edit Quote: {{ editingQuote?.item_identifier || 'Job #' + editingQuote?.job_id }}
          </h3>
          <button @click="closeEditQuoteModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <!-- Form -->
        <form @submit.prevent="updateQuote" class="p-6 space-y-6 overflow-y-auto max-h-[calc(90vh-140px)]">
          <!-- Quote Details -->
          <div class="bg-gray-50 rounded-lg p-6 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2">
              <span class="material-icon-sm text-green-600">request_quote</span>
              Quote Information
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="quote-amount" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">attach_money</span>
                  Quote Amount (R) *
                </label>
                <input
                  type="number"
                  id="quote-amount"
                  v-model="quoteForm.quotation_amount"
                  required
                  step="0.01"
                  min="0"
                  class="form-input"
                  placeholder="0.00"
                >
              </div>
              <div class="space-y-2">
                <label for="quote-valid-until" class="form-label flex items-center gap-2">
                  <span class="material-icon-sm text-gray-500">event_available</span>
                  Valid Until
                </label>
                <input
                  type="date"
                  id="quote-valid-until"
                  v-model="quoteForm.valid_until"
                  class="form-input"
                >
              </div>
            </div>

            <div class="space-y-2">
              <label for="quote-description" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">description</span>
                Quote Description *
              </label>
              <textarea
                id="quote-description"
                v-model="quoteForm.quotation_description"
                required
                rows="4"
                class="form-input resize-none"
                placeholder="Detailed description of work to be performed and quote breakdown..."
              ></textarea>
            </div>

            <div class="space-y-2">
              <label for="quote-document-url" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">link</span>
                Quote Document URL
              </label>
              <input
                type="url"
                id="quote-document-url"
                v-model="quoteForm.quotation_document_url"
                class="form-input"
                placeholder="https://example.com/quote-document.pdf"
              >
              <small class="form-help text-sm text-gray-600">Optional: Link to detailed quote document (PDF, etc.)</small>
            </div>
          </div>

          <!-- PDF Document Upload Section -->
          <div class="bg-green-50 rounded-lg p-6 space-y-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2">
              <span class="material-icon-sm text-green-600">upload_file</span>
              Upload Quote PDF Document
            </h4>

            <div class="space-y-2">
              <label for="quote-pdf-upload" class="form-label flex items-center gap-2">
                <span class="material-icon-sm text-gray-500">picture_as_pdf</span>
                PDF Document Upload
              </label>
              <div class="flex items-center gap-3">
                <input
                  type="file"
                  id="quote-pdf-upload"
                  ref="pdfUploadInput"
                  accept=".pdf"
                  @change="handlePdfUpload"
                  class="form-input flex-1"
                  :disabled="uploadingPdf"
                >
                <button
                  type="button"
                  @click="uploadPdfDocument"
                  :disabled="uploadingPdf || !pdfToUpload"
                  class="btn-primary flex items-center gap-2"
                >
                  <span v-if="uploadingPdf" class="material-icon-sm animate-spin">refresh</span>
                  <span v-else class="material-icon-sm">upload</span>
                  {{ uploadingPdf ? 'Uploading...' : 'Upload PDF' }}
                </button>
              </div>

              <!-- Upload Progress -->
              <div v-if="uploadingPdf" class="space-y-2">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full transition-all" :style="{ width: '50%' }"></div>
                </div>
                <p class="text-sm text-gray-600">Uploading PDF document...</p>
              </div>

              <!-- Uploaded Document Display -->
              <div v-if="uploadedPdfPath" class="space-y-2">
                <div class="flex items-center gap-2 p-3 bg-green-100 border border-green-300 rounded-lg">
                  <span class="material-icon-sm text-green-600">check_circle</span>
                  <div class="flex-1">
                    <p class="font-medium text-green-800">{{ pdfDisplayName }}</p>
                    <p class="text-sm text-green-600">PDF uploaded successfully</p>
                  </div>
                  <a
                    :href="getPdfDownloadUrl(uploadedPdfPath)"
                    target="_blank"
                    class="btn-outlined btn-small flex items-center gap-1"
                  >
                    <span class="material-icon-sm">download</span>
                    View PDF
                  </a>
                </div>
              </div>

              <small class="form-help text-sm text-gray-600">
                Upload a PDF quote document (max 5MB). Alternatively, provide a URL above.
                Both options support quote document delivery. PDF uploads are stored securely and served by our system.
              </small>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
            <button
              type="button"
              @click="closeEditQuoteModal"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">close</span>
              {{ loading ? 'Canceling...' : 'Cancel' }}
            </button>
            <button
              type="submit"
              class="btn-filled flex items-center gap-2"
              :disabled="loading"
            >
              <span v-if="loading" class="material-icon-sm animate-spin">refresh</span>
              <span v-else class="material-icon-sm">save</span>
              {{ loading ? 'Updating...' : 'Update Quote' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Job Modal -->
    <EditJobModal
      v-if="editingJobForModal"
      :job="editingJobForModal"
      :user-role="userRole"
      :technicians="technicians"
      :current-user-id="currentUserId"
      @close="editingJobForModal = null"
      @job-updated="handleJobUpdated"
    />

    <!-- Quote Details Modal -->
    <div v-if="showQuoteDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center">
      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/50" @click="showQuoteDetailsModal = false"></div>

      <!-- Modal Content -->
      <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden" @click.stop>
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
          <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-3">
            <span class="material-icon text-green-600">request_quote</span>
            Quote Details: {{ selectedQuote?.item_identifier || 'Job #' + selectedQuote?.job_id }}
          </h3>
          <button @click="showQuoteDetailsModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>

        <!-- Content -->
        <div v-if="selectedQuote" class="p-6 overflow-y-auto max-h-[calc(90vh-140px)] space-y-6">
          <!-- Quote Status -->
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="status-badge" :class="getQuoteStatusClass(selectedQuote.status)">
                {{ selectedQuote.status }}
              </span>
              <span class="text-sm text-gray-600">
                Created {{ formatDate(selectedQuote.created_at) }}
              </span>
            </div>
            <button @click="showQuoteDetailsModal = false" class="btn-filled">
              Close
            </button>
          </div>

          <!-- Quote Information Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Left Column -->
            <div class="space-y-6">
              <!-- Amount and Validity -->
              <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                  <span class="material-icon-sm text-green-600">attach_money</span>
                  Quote Amount
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="text-sm font-medium text-gray-600">Amount:</label>
                    <p class="text-2xl font-bold text-green-600">{{ formatCurrency(selectedQuote.quotation_amount) }}</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Valid Until:</label>
                    <p class="text-base text-gray-900">{{ formatDate(selectedQuote.valid_until) }}</p>
                  </div>
                  <div v-if="selectedQuote.submitted_at">
                    <label class="text-sm font-medium text-gray-600">Submitted:</label>
                    <p class="text-base text-gray-900">{{ formatDate(selectedQuote.submitted_at) }}</p>
                  </div>
                </div>
              </div>

              <!-- Client Information -->
              <div class="bg-blue-50 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                  <span class="material-icon-sm text-blue-600">business</span>
                  Client Information
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="text-sm font-medium text-gray-600">Client:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.client_name }}</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Location:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.location_name }}</p>
                  </div>
                  <div v-if="selectedQuote.client_email">
                    <label class="text-sm font-medium text-gray-600">Email:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.client_email }}</p>
                  </div>
                  <div v-if="selectedQuote.client_phone">
                    <label class="text-sm font-medium text-gray-600">Phone:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.client_phone }}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
              <!-- Job Information -->
              <div class="bg-purple-50 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                  <span class="material-icon-sm text-purple-600">work</span>
                  Job Information
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="text-sm font-medium text-gray-600">Job:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.item_identifier || 'Job #' + selectedQuote.job_id }}</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Description:</label>
                    <p class="text-base text-gray-900">{{ selectedQuote.fault_description }}</p>
                  </div>
                  <div class="pt-3 border-t border-purple-200">
                    <a :href="`/service-provider/jobs/${selectedQuote.job_id}`" class="btn-filled btn-small inline-flex items-center gap-2">
                      <span class="material-icon-sm">arrow_forward</span>
                      View Full Job Details
                    </a>
                  </div>
                </div>
              </div>

              <!-- Document Links -->
              <div class="bg-green-50 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
                  <span class="material-icon-sm text-green-600">description</span>
                  Documents & Links
                </h4>
                <div class="space-y-3">
                  <div v-if="selectedQuote.quotation_document_url">
                    <label class="text-sm font-medium text-gray-600">Quote Document:</label>
                    <a :href="getPdfDownloadUrl(selectedQuote.quotation_document_url)" target="_blank" class="flex items-center gap-2 text-blue-600 hover:text-blue-800 underline">
                      <span class="material-icon-sm">picture_as_pdf</span>
                      Open PDF Document
                    </a>
                  </div>
                  <div v-else>
                    <p class="text-sm text-gray-600">No PDF document attached</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quote Description -->
          <div class="bg-gray-50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-2 mb-4">
              <span class="material-icon-sm text-orange-600">description</span>
              Quote Description & Breakdown
            </h4>
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <p class="text-gray-900 whitespace-pre-wrap">{{ selectedQuote.quotation_description || 'No description provided' }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal for Full Size View -->
    <div v-if="selectedImage" class="modal-overlay" @click="selectedImage = null">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <h3>{{ selectedImage.original_filename }}</h3>
          <button @click="selectedImage = null" class="close-btn">&times;</button>
        </div>
        <div class="image-modal-body">
          <img :src="generateImageUrl(selectedImage)"
               :alt="selectedImage.original_filename"
               class="full-size-image">
        </div>
      </div>
    </div>
  </div>
</div>
</template>